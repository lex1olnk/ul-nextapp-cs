-- Создание таблицы команд (недостающая сущность)
CREATE TABLE teams (
    team_id SERIAL PRIMARY KEY,
    team_name VARCHAR(255) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE ul_tournaments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Исправленная таблица игроков
CREATE TABLE players (
    id SERIAL PRIMARY KEY, -- Единый стиль именования
    UL_rating FLOAT DEFAULT 0.0,
    nickname VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Исправленная таблица матчей
CREATE TABLE matches (
    id SERIAL PRIMARY KEY, -- Единый стиль именования
    rounds INTEGER NOT NULL,
    started_at TIMESTAMP,
    finished_at TIMESTAMP,
    map VARCHAR(50) NOT NULL,
    team_winner_id INTEGER NOT NULL REFERENCES teams(team_id), -- Исправленная ссылка
    ul_tournament_id UUID REFERENCES ul_tournaments(id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Исправленная таблица статистики игроков
CREATE TABLE match_players (
    match_id INTEGER NOT NULL REFERENCES matches(id), -- Исправленная ссылка
    player_id INTEGER NOT NULL REFERENCES players(id), -- Исправленная ссылка
    player_team_id INTEGER NOT NULL REFERENCES teams(team_id), -- Исправленная ссылка
    kills INTEGER DEFAULT 0,
    deaths INTEGER DEFAULT 0,
    assists INTEGER DEFAULT 0,
    headshots INTEGER DEFAULT 0,
    exchanged INTEGER DEFAULT 0,
    firstdeaths INTEGER DEFAULT 0,
    firstkills INTEGER DEFAULT 0,
    damage INTEGER DEFAULT 0,
    multi_kills INTEGER[5] DEFAULT ARRAY[0,0,0,0,0],
    clutches INTEGER[5] DEFAULT ARRAY[0,0,0,0,0],
    KASTScore FLOAT DEFAULT 0.0,
	Impact FLOAT DEFAULT 0.0,
	Rating FLOAT DEFAULT 0.0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (match_id, player_id)
);

-- Исправленная связующая таблица турниров
CREATE TABLE tournament_matches (
    tournament_id UUID NOT NULL REFERENCES ul_tournaments(id) ON DELETE CASCADE,
    match_id INTEGER NOT NULL REFERENCES matches(id) ON DELETE CASCADE, -- Исправленная ссылка
    PRIMARY KEY (tournament_id, match_id)
);

-- Индексы (оптимизированные)
CREATE INDEX idx_match_players_kills ON match_players(kills);
CREATE INDEX idx_match_players_team ON match_players(player_team_id);
CREATE INDEX idx_matches_tournament ON matches(ul_tournament_id);
CREATE INDEX idx_matches_winner ON matches(team_winner_id);